-- Створюємо таблицю

CREATE TABLE public.test(
    id_order varchar(50) primary key,     
    id_user integer not null,         
    status varchar(50),      
    date_created timestamp not null, 
    amount decimal(10, 1) not null,
    id_region integer
);

/* Фільтруємо статус транзакцій по "success"
 * Знаходимо TS для кожного юзера
 * Групуємо за юзером та регіоном
 */

with UserTotalSpend as(
	select 
		id_user,
		id_region,
		sum(amount) as ts
	from test
	where status = 'success'
	group by id_user, id_region
),

-- Знаходимо AVG TS по регіону

UserAvgTS as(
	select
		id_user,
		id_region,
		ts,
		round(avg(ts) over (partition by id_region),1) as avg_ts_region
	from UserTotalSpend
)

-- Фільтруємо юзерів у яких TS > Avg TS

select
	id_user,
	id_region,
	ts,
	avg_ts_region
from UserAvgTS
where ts > avg_ts_region


