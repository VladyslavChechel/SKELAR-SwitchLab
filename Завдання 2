-- Створюємо таблицю та завантажуємо дані

create table public.events(
	moderator integer not null,
	id_request integer primary key,
	request_time timestamp not null,
	start_time timestamp not null,
	finish_time timestamp not null,
	team varchar(50) not null
);


Аналіз даних
      

            
 select 
	count(distinct moderator) as unique_moderators,					-- Кількість унікальних модераторів
	count( id_request) as total_requests,							-- Кількість запитів
	 min(request_time)::date as first_date_requests, 				--Перша дата запиту 
	 max(request_time)::date as last_date_requests,	 				-- Остання дата запиту
	 count(team) filter (where team = 'wholesale') as wholesale,  	--Кількість запитів по командам
	 count(team) filter (where team = 'retail') as retail			--Кількість запитів по командам
from public.events 


-- Перевіряємо чи можуть оператори працювати у двох командах
select
    moderator
from public.events
group by
    moderator
having
    
    SUM(CASE WHEN team = 'retail' THEN 1 ELSE 0 END) > 0    
    AND 
    SUM(CASE WHEN team = 'wholesale' THEN 1 ELSE 0 END) > 0


    
-- час обробки запиту

select 
	percentile_cont(0.5) within group (order by (finish_time - start_time) ) as median,
	date_trunc('second', avg(finish_time - start_time)) as avg_request_time, -- Середній час обробки запиту (00:02:14)
	date_trunc('second',avg(                           
		case when team = 'retail' then finish_time - start_time
		end)) as avg_request_time_retail,                                    -- Середній час обробки запиту для retail (00:01:58)
	date_trunc('second', avg(
		case when team = 'wholesale' then finish_time - start_time
		end)) as avg_request_time_wholesale                                  -- Середній час обробки запиту для wholesale (00:02:24)
	
from public.events



-- TOP запитів по модераторам 

select 
	count(id_request) as total_requests_by_moderators,
	moderator
from public.events
group by moderator 
order by total_requests_by_moderators desc
-- Модератор № 188 виконав 3746 запитів, інші від 1717 і менше (дізнатись чому така велика різниця? Гіпотеза - автоматичні відповіді або вхід різних модераторів під одним ID)
-- Шість операторів виконали 2 запита або менше (ймовірно допомога старших модераторів або керівництва, відпустки, звільнення, переведення на інші посади або підрозділи)


-- Аналіз роботи модератора № 188 (При медіані виконання запиту за 43с., модератор виконав 148 запитів швидше 5 секунд. Схоже - бот або відповідь надавалась одним словом)
with moderator_188 as (
	select
		moderator,
		team,
		date_trunc('second', avg(finish_time - start_time)) as avg_time,
		PERCENTILE_CONT(0.5) within group (order by (finish_time - start_time)) as median,
		SUM(CASE WHEN (finish_time - start_time) < INTERVAL '5 seconds' THEN 1 ELSE 0 END) AS fast_requests_count
	from public.events
	where moderator = '188'
	group by 
		moderator,
		team
	
)
select 
	moderator,
	avg_time,
	median,
	fast_requests_count
from moderator_188



-- Денне навантаження на модератора
	 
	 with daily_requests_per_moderator as (
	 	select 
	 		moderator,
	 		team,
	 		start_time::date as work_date,
	 		count(id_request) as daily_requests
	 	from public.events
	 	group by 
	 		moderator,
	 		team,
	 		work_date
	 	order by 
	 		work_date
	 )

	 select 
	 	round(avg(case when team = 'retail' then t.daily_requests end ), 0) as avg_daily_requests_retail,
	 	round(avg(case when team = 'wholesale' then t.daily_requests end ), 0) as avg_daily_requests_wholesale
	 from daily_requests_per_moderator as t
	 
	 

-- AVG час виконання запиту для ТОП 10 модераторів retail

select 
	date_trunc('second', avg(e.finish_time - e.start_time)) as avg_time_request_retail,
	t.moderator
from public.events as e
join	(	select
				count(id_request) as count_requests,
				moderator 
			from public.events
			where team = 'retail'
			group by moderator 
			order by count_requests desc
			limit 10
		)as t ON e.moderator = t.moderator
where e.team = 'retail'
group by t.moderator 
order by avg_time_request_retail 


-- AVG час виконання запиту для ТОП 10 модераторів wholesale
-- Різниця середнього часу відповіді оператора 188 і решти, складає більше 38 сек
select 
	date_trunc('second', avg(e.finish_time - e.start_time)) as avg_time_request_wholesale,
	t.moderator
from public.events as e
join	(	select
				count(id_request) as count_requests,
				moderator 
			from public.events
			where team = 'wholesale'
			group by moderator 
			order by count_requests desc
			limit 10
		)as t ON e.moderator = t.moderator
where e.team = 'wholesale'
group by t.moderator 
order by avg_time_request_wholesale 


-- AVG час виконання запиту для BOTTOM 10 модераторів wholesale

select 
	date_trunc('second', avg(e.finish_time - e.start_time)) as avg_time_request_wholesale,
	t.moderator
from public.events as e
join	(	select
				count(id_request) as count_requests,
				moderator 
			from public.events
			where team = 'wholesale'
			group by moderator 
			order by count_requests desc
			limit 10
		)as t ON e.moderator = t.moderator
where e.team = 'wholesale'
group by t.moderator 
order by avg_time_request_wholesale desc


-- К-ть запитів які виконувались більше 15хв., якщо дата початку та кінця виконання запиту співпадає (219 запитів)

with time_request as(
	select
		finish_time - start_time as execution_time
	from public.events
	where (finish_time - start_time) > interval '15 minutes'
	AND start_time::DATE = finish_time::DATE
)
select 
	count(execution_time) as count_waiting_time
from time_request



-- Знаходимо розклад роботи модераторів та к-ть модераторів на зміні

with work_time as 
	(
	select 
		moderator,
		team,
		start_time::date as work_day,
		to_char(MIN(start_time), 'HH24:MI:SS') as start_work,
		to_char(MAX(start_time), 'HH24:MI:SS')  as end_work
	from public.events
	group by
		moderator,
		start_time::date,
		team
	)
	
select 
	work_day,
	count(moderator) as total_moderator_on_shift,
	count(case when team = 'retail' then 1 end) as retail_moderator,  		--к-ть модераторів на зміні retail
	count(case when team = 'wholesale' then 1 end) as wholesale_moderator   --к-ть модераторів на зміні wholesale
from work_time
group by 
	work_day
order by 
	work_day 
